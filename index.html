<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bike Share Route Finder</title>
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  </head>
  <body>
  <div class="container">
    <div class="col-md-12">
          <div class="form-inline inputs">
            <div class="form-group">
              <label for="address-start">Origin:</label>
              <input type="text" id="address-start" placeholder="Starting address" class="form-control">
            </div>
            <div class="form-group">
              <label for="address-end">Destination:</label>
              <input type="text" id="address-end" placeholder="Ending address" class="form-control">
            </div>
            <button type="button" id="search" class="btn btn-success">Go!</button>
          </div>
        <div id="directionsPanel">
          <div id="results"></div>
          <div id="directionsPanelStart"></div>
          <div id="directionsPanelMiddle"></div>
          <div id="directionsPanelEnd"></div>
        </div>
        <div id="map"></div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script type="text/javascript">
      // Application variables
      var addressStart, addressEnd, placeStart, placeEnd;
      var walkTime=0, bikeTime=0, walkDistance=0, bikeDistance=0;
      var stations = [];
      var markers = [];

      // Images
      var markerA = 'img/markerA.png';
      var markerB = 'img/markerB.png';

      // Google Maps API Callback Function
      function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
          // center: {lat: 40.014984, lng: -105.270546},  // Boulder, CO
          // zoom: 14
        });

        // Initialize Google Maps Services
        geocoder = new google.maps.Geocoder();
        infoWindow = new google.maps.InfoWindow();
        distanceMatrixService = new google.maps.DistanceMatrixService;
        directionsService = new google.maps.DirectionsService();

        var bounds = new google.maps.LatLngBounds();

        // Choose Station List
        var markerStation = 'img/bcycle.png';
        var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_boulder/station_information.json";  //Boulder
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_denver/station_information.json";   //Denver
        // var markerStation = 'img/divvy.png';
        // var stationInformationUrl = "https://gbfs.divvybikes.com/gbfs/en/station_information.json" //Chicago

        // TODO: Implement station status: https://gbfs.bcycle.com/bcycle_boulder/station_status.json
        
        // Generate List of Stations        
        $.getJSON(stationInformationUrl, function(data) {          
          $.each(data.data.stations, function(i, station) {
            // Push the station to our array of stations.
            stations.push(station);

            // Create an array of B-Cycle markers from stations.
            var marker = new google.maps.Marker({
              map: map,
              position: new google.maps.LatLng(station.lat, station.lon),
              title: station.name,
              icon: markerStation,
              id: i
            });
            // Push the marker to our array of markers.
            markers.push(marker);
            // Extend the boundaries of the map for each marker
            bounds.extend(marker.position);
          });
          map.fitBounds(bounds);
        });

        // Places autocomplete
        var startAutocomplete = new google.maps.places.Autocomplete(
          document.getElementById('address-start'));    
        var endAutocomplete = new google.maps.places.Autocomplete(
          document.getElementById('address-end'));
        
        // Bias the boundaries within the map for the text.
        startAutocomplete.bindTo('bounds', map);
        endAutocomplete.bindTo('bounds', map);

        // User initiates search:
        document.getElementById('search').addEventListener('click', function() {

          clearAllMarkers();

          document.getElementById("map").style.width = "70%";
          document.getElementById("directionsPanel").style.left = "0px";

          // User inputs
          addressStart = document.getElementById('address-start').value;
          addressEnd = document.getElementById('address-end').value;
          
          // User inputs (as places, if applicable)
          placeStart = startAutocomplete.getPlace();
          placeEnd = endAutocomplete.getPlace();

          var addresses = [
            ["start", addressStart, placeStart],
            ["end", addressEnd, placeEnd]
          ];

          // Get and Display Walking Directions to/from each station
          Promise.all(addresses.map(findRoute))
          // Get and Display Biking Directions from station to station
          .then(function(results) {
            return getDirections(
              results[0],
              results[1],
              "BICYCLING",
              "middle"
            );
          })
          .then(function() {
            displayResults();
          });
        });
      }

      function findRoute(input) {
        /*
          input[0]: 'start' or 'end' station
          input[1]: Manually typed address
          input[2]: Google Place object from Clicking autocomplete suggestion
        */

        return new Promise(function(resolve, reject) {
          var addressToUse;
          
          // Check whether user clicked a place or manually entered an address.
          if (input[2] == undefined) {    // Address given
            addressToUse = input[1];
          } else {                        // Place given
            addressToUse = input[2].formatted_address;
          }

          // Verify Address
          geoCodeAddress(addressToUse)
          .then(function(results) {

          // Add a Marker for address
            console.log("geocoded address: \n"+results[0]);
            return results[0];
          })

          // Find closest B-Cycle station near address
          .then(function(geo_address) {
            return findNearestStation(geo_address);
          })

          // Find walking directions from address to station
          .then(function(results) {                
            resolve(results[1]);
            if(input[0] === "start") {
              return getDirections(
                results[0], // Origin
                results[1], // Destination
                results[2], // TravelMode
                input[0]    // Route Leg
              );
            } else {
              return getDirections(
                results[1], // Origin
                results[0], // Destination
                results[2], // TravelMode
                input[0]    // Route Leg
              );                  
            }
          })
          .then(function(results) {
            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < markers.length; i++) {
              if (markers[i].map != null) {
                bounds.extend(markers[i].position);
              }
            }
            map.fitBounds(bounds);
          })
          .catch(function(status){
            console.log(status);
            reject(status);
          });   
        });
      }

      function findNearestStation(address) {
        return new Promise(function(resolve, reject) {

          // Check to make sure the place entered isn't blank.
          if (address == '') {
            reject(Error('Must enter an address.'));
          }
          else {
            // Find the closest station, using pyth distance
            // Get LatLng coordinates for current address
            var addLat = parseFloat(address.geometry.location.lat());
            var addLng = parseFloat(address.geometry.location.lng());

            // find the pyth distance of each station to current address, and return index of min distance
            var pythDistances = [];
            var min = 1;
            var index = 0;

            for (var i = 0; i < stations.length; i++) {
              curr = Math.sqrt(Math.pow(addLat - parseFloat(stations[i].lat),2)+Math.pow(addLng - parseFloat(stations[i].lon),2));
              if (curr < min) {
                min = curr;
                index = i;
              }
            }
          }
          console.log("Nearest B-Cycle station: \n" + stations[index].name);
          markers[index].setMap(map);
          resolve([address.formatted_address, markers[index].position, 'WALKING']);
        });
      }

      function getDirections(orig, dest, mode, routeLeg) {
        return new Promise(function(resolve, reject) {
          // var alternate = false;
          // if (mode == "BICYCLING") {alternate = true;}
          directionsService.route({
            origin: orig,
            destination: dest,
            travelMode: google.maps.TravelMode[mode],
            unitSystem: google.maps.UnitSystem.IMPERIAL,
            // provideRouteAlternatives: alternate
          }, function(response, status) {
            if (status !== google.maps.DirectionsStatus.OK) {
              console.log(status);
              reject(Error(status));
            } else {
              var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true, suppressBicyclingLayer: true});
              directionsDisplay.setMap(map);
              directionsDisplay.setDirections(response);

              if (mode == "WALKING") {
                walkTime += response.routes[0].legs[0].duration.value;
                walkDistance += response.routes[0].legs[0].distance.value;
                if (routeLeg == "start") {
                  directionsDisplay.setPanel(document.getElementById('directionsPanelStart'));
                  marker = new google.maps.Marker({
                    map: map,
                    position: response.routes[0].legs[0].start_location,
                    title: "Origin",
                    icon: markerA
                  });
                  markers.push(marker);
                } else {
                  directionsDisplay.setPanel(document.getElementById('directionsPanelEnd'));
                  marker = new google.maps.Marker({
                    map: map,
                    position: response.routes[0].legs[0].end_location,
                    title: "Destination",
                    icon: markerB
                  });
                  markers.push(marker);
                }
              } else {
                bikeTime += response.routes[0].legs[0].duration.value;
                bikeDistance += response.routes[0].legs[0].distance.value;
                directionsDisplay.setPanel(document.getElementById('directionsPanelMiddle'));
              }
              // console.log(response);
              resolve(response);
            }
          });
        });
      }


      function clearAllMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
          }
      }
      
      function geoCodeAddress(address) {
        return new Promise(function(resolve,reject) {
          // Check if input is a place. Else, assume Address.
          geocoder.geocode( { 'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              console.log(results);
              resolve(results);
            } else {
              reject(status);
            }
          });
        });
      }

      function displayResults() {
        // return new Promise(function(resolve,reject) {
          var totalTimeFormatted, walkDistanceFormatted, bikeDistanceFormatted;

          totalTimeFormatted = (Math.round((walkTime+bikeTime)/60))+" mins";

          if (walkDistance <= 160) {
            walkDistanceFormatted = Math.round(walkDistance*3.28084)+" ft";
          } else {
            walkDistanceFormatted = (Math.round(walkDistance*0.000621371 * 10) / 10)+" mi";
          }

          if (bikeDistance <= 160) {
            bikeDistanceFormatted = Math.round(bikeDistance*3.28084)+" ft";
          } else {
            bikeDistanceFormatted = (Math.round(bikeDistance*0.000621371 * 10) / 10)+" mi";
          }

          var resultsList = document.querySelector('results');

          results.innerHTML = "<h4>Time to Destination: "+totalTimeFormatted+"</h4><h4>Biking Distance: "+bikeDistanceFormatted+"</h4><h4>Walking Distance: "+walkDistanceFormatted+"</h4>";

          // // Update marker icons in results panel for B-cycle stations
          // var markerIcons = document.getElementsByClassName('adp-marker');
          // for (var i = 1; i < markerIcons.length-1; i++) {
          //     console.log(markerIcons[i]);
          //     markerIcons[i].src=markerStation;
          // }
          // resolve(results);
        // });
      };

      function createMarker(element, index, array) {
        var html = "<b>" + element.name + "</b> <br/>" + element.formatted_address;
        var marker = new google.maps.Marker({
          map: map,
          position: element.geometry.location,
          animation: google.maps.Animation.DROP,
          title: element.formatted_address
        });
        google.maps.event.addListener(marker, 'click', function() {
          infoWindow.setContent(html);
          infoWindow.open(map, marker);
        });
        // bounds.extend(element.geometry.location);
        markers.push(marker);
      }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?libraries=places,geometry,drawing&key=AIzaSyAmNH8x1MOyTmnODOCfcfnFdkJ0-pLg1Ew&v=3&callback=initMap">
    </script>

  </body>
</html>
