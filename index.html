<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bike Share Route Finder</title>
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  </head>
  <body>
  <div class="container">
    <div class="col-md-12">
          <div class="form-inline inputs">
            <div class="form-group">
              <label for="address-start">Origin:</label>
              <input type="text" id="address-start" placeholder="Starting address" class="form-control">
            </div>
            <div class="form-group">
              <label for="address-end">Destination:</label>
              <input type="text" id="address-end" placeholder="Ending address" class="form-control">
            </div>
            <button type="button" id="search" class="btn btn-success">Go!</button>
          </div>
        <div id="directionsPanel">
          <div id="results"></div>
          <div id="directionsPanelStart"></div>
          <div id="directionsPanelMiddle"></div>
          <div id="directionsPanelEnd"></div>
        </div>
        <div id="map"></div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script type="text/javascript">
      // Application variables
      var addressStart, addressEnd, placeStart, placeEnd;
      var walkTime=0, bikeTime=0, walkDistance=0, bikeDistance=0;
      var stations = [];
      var markers = [];

      // Images
      var markerA = 'img/markerA.png';
      var markerB = 'img/markerB.png';

      // Google Maps API Callback Function
      function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
          // center: {lat: 40.014984, lng: -105.270546},  // Boulder, CO
          // zoom: 14
        });

        // Initialize Google Maps Services
        geocoder = new google.maps.Geocoder();
        infoWindow = new google.maps.InfoWindow();
        distanceMatrixService = new google.maps.DistanceMatrixService;
        directionsService = new google.maps.DirectionsService();

        var bounds = new google.maps.LatLngBounds();

        // Choose Station List
        var markerStation = 'img/bcycle.png';
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_arborbike/station_information.json" // Ann Arbor
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_austin/station_information.json" // Austin
        var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_boulder/station_information.json";  // Boulder
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_denver/station_information.json";   // Denver
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_lametro/station_information.json"; // Los Angeles
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_madison/station_information.json"; // Madison
        // var stationInformationUrl = "https://gbfs.citibikenyc.com/gbfs/en/station_information.json"; // New York City
        // var stationInformationUrl = "https://gbfs.bcycle.com/bcycle_indego/station_information.json" // Philadelphia
        // var stationInformationUrl = "https://gbfs.bayareabikeshare.com/gbfs/en/station_information.json" // San Francisco
        // var stationInformationUrl = "http://santamonicabikeshare.com/opendata/station_information.json" // Santa Monica
        // var markerStation = 'img/divvy.png';
        // var stationInformationUrl = "https://gbfs.divvybikes.com/gbfs/en/station_information.json" //Chicago

        // TODO: Implement station status: https://gbfs.bcycle.com/bcycle_boulder/station_status.json
        
        // Generate List of Stations        
        $.getJSON(stationInformationUrl, function(data) {          
          $.each(data.data.stations, function(i, station) {
            // Push the station to our array of stations
            stations.push(station);

            // Create station markers
            var marker = new google.maps.Marker({
              map: map,
              position: new google.maps.LatLng(station.lat, station.lon),
              title: station.name,
              icon: markerStation,
              id: i
            });
            // Push the marker to our array of markers
            markers.push(marker);
            // Extend the boundaries of the map for each marker
            bounds.extend(marker.position);
          });
          map.fitBounds(bounds);
        });

        // Places autocomplete
        var startAutocomplete = new google.maps.places.Autocomplete(
          document.getElementById('address-start'));    
        var endAutocomplete = new google.maps.places.Autocomplete(
          document.getElementById('address-end'));
        
        // Bias the boundaries within the map for the text
        startAutocomplete.bindTo('bounds', map);
        endAutocomplete.bindTo('bounds', map);

/////////////////////////////////////////////////////
        // User initiates search:
/////////////////////////////////////////////////////        
        document.getElementById('search').addEventListener('click', function() {

          clearAllMarkers();
          // document.getElementById("map").style.width = "70%";
          // document.getElementById("directionsPanel").style.left = "0px";

          // User inputs
          addressStart = document.getElementById('address-start').value;
          addressEnd = document.getElementById('address-end').value;
          
          // User inputs (as places, if applicable)
          placeStart = startAutocomplete.getPlace();
          placeEnd = endAutocomplete.getPlace();

          // If user clicked a place, set place address as the address
          if (placeStart != undefined) {    // Place given
            addressStart = placeStart.formatted_address;
          };

          if (placeEnd != undefined) {    // Place given
            addressEnd = placeEnd.formatted_address;
          };

          var addresses = [[addressStart],[addressEnd]];
          var geoAddresses = [];


          // Begin Promise chain

          // Geocode addresses
          Promise.all([
              geoCodeAddress(addressStart),
              geoCodeAddress(addressEnd)
            ])
          // Set Geocoded addresses and find bike station nearest to each address
          .then(function(results) {
            geoAddresses.push(results[0][0]);
            geoAddresses.push(results[1][0]);

            return new Promise(function(resolve, reject) {
              addresses[0].push(findNearestStation(results[0][0]));
              addresses[1].push(findNearestStation(results[1][0]));
              resolve();
            });
          })
          // Get directions
          .then(function(results) {
            return Promise.all([
                getDirections(addresses[0][0], addresses[0][1], "WALKING"),   // start
                getDirections(addresses[1][0], addresses[1][1], "WALKING"),   // end
                getDirections(addresses[0][1], addresses[1][1], "BICYCLING")  // middle
              ])
          })
          // Sum up direction distance and duration
          .then(function(results) {
              walkDistance = results[0].routes[0].legs[0].distance.value + results[1].routes[0].legs[0].distance.value;
              walkTime = results[0].routes[0].legs[0].duration.value + results[1].routes[0].legs[0].duration.value;
              bikeDistance = results[2].routes[0].legs[0].distance.value;
              bikeTime = results[2].routes[0].legs[0].duration.value;
              return results;
          })
          // Add directions to map and directions panel
          .then(function(results) {
            return Promise.all([
                displayDirections(results[0], "directionsPanelStart"),
                displayDirections(results[1], "directionsPanelEnd"),
                displayDirections(results[2], "directionsPanelMiddle")
              ])
          })
          // Add start and end markers to map
          .then(function(results) {
            console.log(geoAddresses);
            return Promise.all([
                createMarker(map, geoAddresses[0].geometry.location, "Origin", markerA),
                createMarker(map, geoAddresses[1].geometry.location, "Destination", markerB)
              ])
          })
          // Reset map's bounds based on active markers
          .then(function(results) {
            fitMapToBounds(map, markers);
          })
          // Display results panel (total distance and duration)
          .then(function(results) {
            displayResults();
          })
          .catch(function(status){
            console.log(status);
            Error(status);
          });
        });
      }


      function clearAllMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
          }
      }


      function geoCodeAddress(address) {
        return new Promise(function(resolve,reject) {
          // Check if input is a place. Else, assume Address.
          geocoder.geocode( {'address': address}, function(results, status) {
            if (status !== google.maps.GeocoderStatus.OK) {
              console.log(status)
              reject(status);
            } else {
              // console.log("Geocoded results:");
              // console.log(results);
              resolve(results);
            }
          });
        });
      }


      function findNearestStation(address) {
          // console.log(address);
          // Find the closest station, using pyth distance
          // Get LatLng coordinates for current address
          var addLat = parseFloat(address.geometry.location.lat());
          var addLng = parseFloat(address.geometry.location.lng());

          // find the pyth distance of each station to current address, and return index of min distance
          var pythDistances = [];
          var min = 1;
          var index = 0;

          for (var i = 0; i < stations.length; i++) {
            curr = Math.sqrt(Math.pow(addLat - parseFloat(stations[i].lat),2)+Math.pow(addLng - parseFloat(stations[i].lon),2));
            if (curr < min) {
              min = curr;
              index = i;
            }
          }
          // console.log("Nearest B-Cycle station: \n" + stations[index].name);
          markers[index].setMap(map);
          // console.log(markers[index].position);
          return markers[index].position;
      }


      function getDirections(orig, dest, mode) {
        return new Promise(function(resolve, reject) {
          directionsService.route({
              origin: orig,
              destination: dest,
              travelMode: google.maps.TravelMode[mode],
              unitSystem: google.maps.UnitSystem.IMPERIAL,
            }, function(response, status) {
              if (status !== google.maps.DirectionsStatus.OK) {
                console.log(status);
                reject(Error(status));
              } else {
                console.log("directionsService:");
                console.log(response);
                resolve(response);
              }
            });
        });
      }


      function displayDirections(directions, panel) {
        return new Promise(function(resolve, reject) {
          var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true, suppressBicyclingLayer: true});
          directionsDisplay.setDirections(directions);
          directionsDisplay.setMap(map);
          directionsDisplay.setPanel(document.getElementById(panel));
          resolve();
        });
      }

      // Create a new marker
      function createMarker(map, position, title, icon) {
        return new Promise(function(resolve, reject) {
          marker = new google.maps.Marker({
            map: map,
            position: position,
            title: title,
            icon: icon
          });
          markers.push(marker);
          resolve();
        });
      }

 // Extend a map's bounds based on active markers, and fit map to bounds
      function fitMapToBounds(map, markers) {
        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < markers.length; i++) {
          if (markers[i].map != null) {
            console.log(markers[i].position);
            bounds.extend(markers[i].position);
          }
        }
        map.fitBounds(bounds);
      }


      function displayResults() {
        // return new Promise(function(resolve,reject) {
          var totalTimeFormatted, walkDistanceFormatted, bikeDistanceFormatted;

          totalTimeFormatted = (Math.round((walkTime+bikeTime)/60))+" mins";

          if (walkDistance <= 160) {
            walkDistanceFormatted = Math.round(walkDistance*3.28084)+" ft";
          } else {
            walkDistanceFormatted = (Math.round(walkDistance*0.000621371 * 10) / 10)+" mi";
          }

          if (bikeDistance <= 160) {
            bikeDistanceFormatted = Math.round(bikeDistance*3.28084)+" ft";
          } else {
            bikeDistanceFormatted = (Math.round(bikeDistance*0.000621371 * 10) / 10)+" mi";
          }

          var resultsList = document.querySelector('results');

          results.innerHTML = "<h4>Time to Destination: "+totalTimeFormatted+"</h4><h4>Biking Distance: "+bikeDistanceFormatted+"</h4><h4>Walking Distance: "+walkDistanceFormatted+"</h4>";

          // // Update marker icons in results panel for B-cycle stations
          // var markerIcons = document.getElementsByClassName('adp-marker');
          // for (var i = 1; i < markerIcons.length-1; i++) {
          //     console.log(markerIcons[i]);
          //     markerIcons[i].src=markerStation;
          // }
          // resolve(results);
        // });
      };

      // function createMarker(element, index, array) {
      //   var html = "<b>" + element.name + "</b> <br/>" + element.formatted_address;
      //   var marker = new google.maps.Marker({
      //     map: map,
      //     position: element.geometry.location,
      //     animation: google.maps.Animation.DROP,
      //     title: element.formatted_address
      //   });
      //   google.maps.event.addListener(marker, 'click', function() {
      //     infoWindow.setContent(html);
      //     infoWindow.open(map, marker);
      //   });
      //   // bounds.extend(element.geometry.location);
      //   markers.push(marker);
      // }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?libraries=places,geometry,drawing&key=AIzaSyAmNH8x1MOyTmnODOCfcfnFdkJ0-pLg1Ew&v=3&callback=initMap">
    </script>

  </body>
</html>
